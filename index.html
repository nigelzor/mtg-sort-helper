<!doctype html>
<html>
<head>
    <title>MTG Sort Helper</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }
        .grid {
            display: grid;
            grid-auto-flow: column;
            grid-column-gap: 1em;
            grid-row-gap: 0.2em;
            border-left: 0.5em solid transparent;
            padding-left: 0.5em;
        }
        .grid.W {
            border-color: #f8e7b9;
            /*border-color: #f9faf4;*/
            /*border-color: rgb(177,163,147);*/
        }
        .grid.U {
            border-color: #b3ceea;
            border-color: #0e68ab;
            /*border-color: rgb(68,125,154);*/
        }
        .grid.B {
            border-color: #a69f9d;
            border-color: #150b00;
            /*border-color: rgb(36,38,32);*/
        }
        .grid.R {
            border-color: #eb9f82;
            border-color: #d3202a;
            border-color: rgb(135,6,36);
        }
        .grid.G {
            border-color: #c4d3ca;
            border-color: #00733e;
            /*border-color: rgb(69,95,77);*/
        }
        .grid.artifact {
            border-color: #7f5845;
            /*border-color: rgb(82,61,47);*/
        }
        .grid.land {
            border-color: #91837a;
        }
        .grid.multi {
            border-color: rgb(143,128,67);
            border-color: rgb(213,175,70);
        }
        #output.focus:hover > .grid:not(:hover) {
            opacity: 30%;
        }
        .card {
            display: flex;
            align-items: center;
        }
        .name {
            text-decoration: none;
        }
        .number {
            margin-left: 0.25em;
            font-size: smaller;
            color: #ccc;
        }
        .price {
            margin-left: 0.25em;
            font-size: smaller;
            border-radius: 1em;
            padding: 0 0.2em;
        }
        .price.rare {
            background-color: gold;
        }
        .price.common {
            color: white;
            background-color: black;
        }
        .price.uncommon {
            background-color: silver;
        }
        .price.mythic {
            background-color: orchid;
        }
    </style>
</head>
<body>
<form id="filter">
    <label>
        Set:
        <select id="set">
            <option selected>(none selected)</option>
        </select>
    </label>
    <label>
        Exclude Rares:
        <input id="rares" type="checkbox" checked />
    </label>
    <label>
        Columns:
        <input id="columns" type="number" min="1" value="6" />
    </label>
    <label>
        Focus:
        <input id="focus" type="checkbox" />
    </label>
</form>
<hr/>
<div id="output"></div>
</body>
<script type="module">

function h(tag, attributes = {}, children) {
    const element = document.createElement(tag);
    for (const attribute in attributes) {
        if (attributes.hasOwnProperty(attribute)) {
            element.setAttribute(attribute, attributes[attribute]);
        }
    }
    children?.forEach((child) => {
        element.appendChild(typeof child === 'string' ? document.createTextNode(child) : child);
    });
    return element
}

function fetchAll(url) {
    return fetch(url).then((resp) => resp.json()).then((json) => {
        if (json.has_more) {
            return fetchAll(json.next_page).then((more) => json.data.concat(more));
        }
        return json.data;
    });
}

function chunkify(cards) {
    function color(card) {
        if (card.colors?.length > 1) {
            return 'multi';
        } else if (card.colors?.length === 1) {
            return card.colors[0];
        } else if (/Land/.test(card.type_line)) {
            return 'land';
        } else if (/Artifact/.test(card.type_line)) {
            return 'artifact';
        }
        return 'unknown';
    }

    const chunks = [];
    let lc;
    for (const card of cards) {
        const c = color(card);
        if (lc == null || lc !== c) {
            chunks.push({ color: c, cards: [card] });
        } else {
            chunks[chunks.length - 1].cards.push(card);
        }
        lc = c;
    }
    return chunks;
}

document.addEventListener('DOMContentLoaded', function () {
    const output = document.getElementById('output');
    const setInput = document.getElementById('set');
    const raresInput = document.getElementById('rares');
    const columnsInput = document.getElementById('columns');
    const focusInput = document.getElementById('focus');

    let sets = null;
    let cards = [];

    loading();
    fetchAll('https://api.scryfall.com/sets').then((result) => {
        sets = result.reverse();
        sets.forEach((set) => {
            const option = h('option', { value: set.code }, [set.name]);
            setInput.appendChild(option);
        });
        redraw();
    });

    setInput.addEventListener('change', (event) => {
        if (setInput.firstElementChild.textContent === '(none selected)') {
            setInput.removeChild(setInput.firstElementChild);
        }
        const search = sets.find((s) => s.code === event.currentTarget.value).search_uri;
        loading();
        fetchAll(search).then((result) => {
            cards = result;
            redraw();
        });
    });
    raresInput.addEventListener('change', redraw);
    columnsInput.addEventListener('change', redraw);

    function handleFocusChange() {
        output.classList[focusInput.checked ? 'add' : 'remove']('focus');
    }
    focusInput.addEventListener('change', handleFocusChange);
    handleFocusChange();

    function loading() {
        while (output.hasChildNodes()) {
            output.removeChild(output.firstChild);
        }
        output.textContent = 'Loading...'
    }

    function redraw() {
        while (output.hasChildNodes()) {
            output.removeChild(output.firstChild);
        }
        let selected = cards;
        if (raresInput.checked) {
            selected = selected.filter((c) => c.rarity !== "rare" && c.rarity !== "mythic");
        }
        for (const chunk of chunkify(selected)) {
            const grid = h('div', { class: `grid ${chunk.color}` }, []);
            const n = Math.ceil(chunk.cards.length / columnsInput.value);
            grid.style.gridTemplateColumns = `repeat(${columnsInput.value},1fr)`;
            grid.style.gridTemplateRows = `repeat(${n},auto)`;
            for (const c of chunk.cards) {
                const children = [h('a', { class: 'name', href: c.scryfall_uri, target: '_blank' }, [c.name])];
                if (c.collector_number) {
                    children.push(h('span', { class: 'number' }, [`${c.collector_number}`]));
                }
                if (c.prices?.usd > 1) {
                    children.push(h('span', { class: `price ${c.rarity}` }, [`$${c.prices.usd}`]));
                }
                grid.appendChild(h('div', { class: 'card' }, children));
            }
            output.appendChild(grid);
            output.appendChild(h('hr'));
        }
    }
});
</script>
</html>
