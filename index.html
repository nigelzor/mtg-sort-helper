<!doctype html>
<html>
<head>
    <title>MTG Sort Helper</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }
        .grid {
            display: grid;
            grid-auto-flow: column;
            grid-column-gap: 1em;
            grid-row-gap: 0.2em;
        }
        #output:hover > .grid:not(:hover) {
            opacity: 30%;
        }
        .card {
            display: flex;
            align-items: center;
        }
        .name {
            text-decoration: none;
        }
        .number {
            margin-left: 0.25em;
            font-size: smaller;
            color: #ccc;
        }
        .price {
            margin-left: 0.25em;
            font-size: smaller;
            border-radius: 1em;
            padding: 0 0.2em;
        }
        .price.rare {
            background-color: gold;
        }
        .price.common {
            color: white;
            background-color: black;
        }
        .price.uncommon {
            background-color: silver;
        }
        .price.mythic {
            background-color: orchid;
        }
    </style>
</head>
<body>
<form id="filter">
    <label>
        Set:
        <select id="set"></select>
    </label>
    <label>
        Exclude Rares:
        <input id="rares" type="checkbox" checked />
    </label>
    <label>
        Columns:
        <input id="columns" type="number" min="1" value="6" />
    </label>
</form>
<hr/>
<div id="output"></div>
</body>
<script type="module">

function h(tag, attributes = {}, children) {
    const element = document.createElement(tag);
    for (const attribute in attributes) {
        if (attributes.hasOwnProperty(attribute)) {
            element.setAttribute(attribute, attributes[attribute]);
        }
    }
    children?.forEach((child) => {
        element.appendChild(typeof child === 'string' ? document.createTextNode(child) : child);
    });
    return element
}

function fetchAll(url) {
    return fetch(url).then((resp) => resp.json()).then((json) => {
        if (json.has_more) {
            return fetchAll(json.next_page).then((more) => json.data.concat(more));
        }
        return json.data;
    });
}

function chunkify(cards) {
    function color(card) {
        if (card.colors?.length > 1) {
            return 'multi';
        } else if (card.colors?.length === 1) {
            return card.colors[0];
        } else if (/Land/.test(card.type_line)) {
            return 'land';
        } else if (/Artifact/.test(card.type_line)) {
            return 'artifact';
        }
        return 'unknown';
    }

    const chunks = [];
    let lastCard;
    for (const card of cards) {
        if (lastCard == null || color(card) !== color(lastCard)) {
            chunks.push([card]);
        } else {
            chunks[chunks.length - 1].push(card);
        }
        lastCard = card;
    }
    return chunks;
}

document.addEventListener('DOMContentLoaded', function () {
    const output = document.getElementById('output');
    const setInput = document.getElementById('set');
    const raresInput = document.getElementById('rares');
    const columnsInput = document.getElementById('columns');

    let sets = null;
    let cards = [];

    loading();
    fetchAll('https://api.scryfall.com/sets').then((result) => {
        sets = result.reverse();
        sets.forEach((set) => {
            const option = h('option', { value: set.code }, [set.name]);
            setInput.appendChild(option);
        });
        redraw();
    });

    setInput.addEventListener('change', (event) => {
        const search = sets.find((s) => s.code === event.currentTarget.value).search_uri;
        loading();
        fetchAll(search).then((result) => {
            console.log(result.map((c) => c.name));
            cards = result;
            redraw();
        });
    });
    raresInput.addEventListener('change', redraw);
    columnsInput.addEventListener('change', redraw);

    function loading() {
        while (output.hasChildNodes()) {
            output.removeChild(output.firstChild);
        }
        output.textContent = 'Loading...'
    }

    function redraw() {
        while (output.hasChildNodes()) {
            output.removeChild(output.firstChild);
        }
        let selected = cards;
        if (raresInput.checked) {
            selected = selected.filter((c) => c.rarity !== "rare" && c.rarity !== "mythic");
        }
        for (const chunk of chunkify(selected)) {
            const grid = h('div', { class: 'grid' }, []);
            const n = Math.ceil(chunk.length / columnsInput.value);
            grid.style.gridTemplateColumns = `repeat(${columnsInput.value},1fr)`;
            grid.style.gridTemplateRows = `repeat(${n},auto)`;
            for (const c of chunk) {
                const children = [h('a', { class: 'name', href: c.scryfall_uri, target: '_blank' }, [c.name])];
                if (c.collector_number) {
                    children.push(h('span', { class: 'number' }, [`${c.collector_number}`]));
                }
                if (c.prices?.usd > 1) {
                    children.push(h('span', { class: `price ${c.rarity}` }, [`$${c.prices.usd}`]));
                }
                grid.appendChild(h('div', { class: 'card' }, children));
            }
            output.appendChild(grid);
            output.appendChild(h('hr'));
        }
    }
});
</script>
</html>
